<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nucleosome Occupancy (Browser)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --grid: #e5e7eb;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 16px;
    }

    header {
      padding: 16px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--grid);
    }

    h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      padding: 0 20px 20px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: 10px;
    }

    .card h2 {
      font-size: 14px;
      margin: 0;
      padding: 12px 14px;
      border-bottom: 1px solid var(--grid);
      color: var(--muted);
      font-weight: 600;
    }

    .card .content {
      padding: 12px 14px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin: 12px 0 6px;
    }

    textarea,
    input,
    button {
      width: 100%;
      box-sizing: border-box;
    }

    textarea,
    input {
      background: #ffffff;
      border: 1px solid var(--grid);
      color: var(--text);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 13px;
    }

    textarea {
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    button {
      margin-top: 14px;
      background: var(--accent);
      border: none;
      color: #ffffff;
      font-weight: 700;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: filter .15s ease-in-out;
      font-size: 14px;
    }

    button:hover {
      filter: brightness(1.05);
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    canvas {
      background: #ffffff;
      border-radius: 10px;
    }

    .error {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    .footer {
      font-size: 12px;
      color: var(--muted);
      padding: 0 20px 20px;
    }
  </style>
</head>

<body>
  <header>
    <h1>Nucleosome Occupancy</h1>
  </header>
  <div class="container">
    <div class="card">
      <h2>Inputs</h2>
      <div class="content">
        <label for="sequence">DNA sequence (A/C/G/T)</label>
        <textarea id="sequence" spellcheck="false" placeholder="Paste or type sequence here..."></textarea>
        <div class="row">
          <div>
            <label for="period">Period (bp)</label>
            <input id="period" type="number" step="0.1" value="10.1" />
          </div>
          <div>
            <label for="footprint">Footprint (bp)</label>
            <input id="footprint" type="number" step="1" value="147" />
          </div>
          <div>
            <label for="amplitude">Amplitude (B)</label>
            <input id="amplitude" type="number" step="0.01" value="0.2" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="chemicalPotential">Chemical potential (kT)</label>
            <input id="chemicalPotential" type="number" step="0.1" value="-8.5" />
          </div>
          <div></div>
          <div></div>
        </div>
        <button id="runBtn">Run</button>
        <div id="error" class="error"></div>
        <p class="note">Runs your Python code in-browser via Pyodide. Sequence is uppercased and converted Uâ†’T. Non-ACGT
          removed.</p>
      </div>
    </div>

    <div class="card">
      <h2>Occupancy</h2>
      <div class="content">
        <canvas id="chart" height="320"></canvas>
      </div>
    </div>
  </div>
  <div class="footer">Tip: For GitHub Pages, place this file in docs/ and enable Pages in settings.</div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Pyodide for Python in the browser -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script>
    const elSeq = document.getElementById('sequence');
    const elMu = document.getElementById('chemicalPotential');
    const elFoot = document.getElementById('footprint');
    const elAmp = document.getElementById('amplitude');
    const elPer = document.getElementById('period');
    const elRun = document.getElementById('runBtn');
    const elErr = document.getElementById('error');
    const ctx = document.getElementById('chart');

    // Seed example
    elSeq.value = 'CTGGGGTTATACTTTAATAGGAAGGGGGGAACAAGTATACTTACAGAGCTGTCTATATAACGGTCATGAAATTAGGGTTCACCCGAGGAAGCCCTTTTTGCGAGGCCCGTACCGAAGCCGCACCGGACTTTTGTGGGGCAGTCCTCCCATCCACATGCTGCCGGAGTTAAATCTTTCTCACTTTTCCACGCGATTGAGCACGTGGCTGGTGAATACTTTTGACTATTAGTCCTCTTTGCACATCAATTGGGGAGATTCCTGTGTTTCCAAGGTCAAAGACGAGGGTCAACCTCAAAAAGTGGAATCACACGATATAATATGTTGCAAACTAGTTGGTAAAACGTCCACTCCTGGATCGACTGGGCCTACCTATTCACCTCACTTGGTTAACTCCGTTTGGGACAGTTTCTCCTCACCCACGTCATTTGCGGTGAGAACCTACGATTTTTTCCAAGGTCGTAACTCGACGTTAACCCGGCCGAACAGCACCCAGCGCCGCTGAGACCTCAGTTAAAATTCCTATAATGGTTCGGATTCGGTCGTACGATAGTCATCGGACTAACTTTTCCTCTACGGAGTGCAGAGCTCCCCATGCCCGATAAGCAGGTAGTGATTGTACCTCAGACTGGTGTTACTCCACCCTTTGGCTATCCGCGCGTTTGAGAATCGTTCATTCGCAAACTAGTTTATGTGTCGACCGCATGCTGCAAAGTACCTAAAATGGGCTCATAACCCAACCGCAGCAGAGACATGTCCCCGAGGCTTTTGATTCAAAGGTCGGGACACTAAAGATTAATCCATCCAAACATAATGGGTAATGCCACTATGGATGTTCTTTGTTCTGAACCTCTCGGGTCGTGACTTAATGCGTCCACCTTACCATTAGTACACCATTGTCAATACAAGCACTGAGTGCTCGCCCTTCTACAGGATGTATATATCTGACACGTGCCTGGAGACTAGGGAGTAATCCCCTTGGCGGTTAAAACGCGGGGGACAGCGCGTACGTGCGTTTAAGCGGTGCTAGAGCTGTCTACGACCAATTGAGCGGCCTCGGCACCGGGATTCTCCAGATGCCGCCACTACCGACACCCCGTAACTCCTGGGAGGGTATTCAAGGGCCCTTCTGATGAATACCATTGTGCTTATTTGTGTTCCGATTTTAAGTTAGCCCGCTATCTGGACAGTAATGAAACACCAGTGGTTAACATGCCAAATTATGTATTAGCTCTCTTAGGAAGTCACGGGGGCGAGGGGGTGTAGCAGCCTATGTGGTTTTGGTCGTTCTTAGGAACGCACATTCACTGCGATCTCACAGTTCACTACGCGGTATTCGATAGAACTATGGCAGAAGTGTCCTGATCGCTGATAATTTTCCGGTTTATTGCAACGGGGAACTGTTGCTCAGGTCACGGCTAACGGTATCTTCGAAATTCGACTGTAGGTTGATCTCCGGCGATGTAGAGTTGGTTATGTAGATCCACCCTTAGAGGTTTCGCCTATGGGCCCCGTTTGCAATTTGGTTGTCACTAGGGAATGCACATTATAACAAAACCTGTCCACGGGGGGGTCCATTTAGCGCGGTTCTCATATGGCGACATATATTGGCCACTATGCGGGAATTGAAAGAGTGGCCGAAGGTAGGTCCGTTAATCCCCCGACAAAATGGTACCCGTTTCATTGCTGGCTGAGTCAGAATTAGGATAGTAGTCGATGGGTACGGTGCATTTAAGCTACCGACGCGGTCACCTGATCCCAGGCGATCACAGACAACGGCACGGGATCCGTGCAAACACAGCCTATTTCGGTCGCCATGGCCATTCACGAAGGCCCTCAACTTCTCTACAGGTTCACGGTCGATATAACCTTGCAGCGAGCCGCTTCCCACGTTCTGACACTTAGGGTATTCTTCGCGAACGGAATTGGAGCTACGGCCAGCTAGCGACGTAGGTCCGTCGAACCACTACCTACCCAACATGGAGCCGTAACATTGATCTGA'
    let chart;
    function render(occupancy) {
      const labels = Array.from({ length: occupancy.length }, (_, i) => i);
      const ds = { label: 'Occupancy', data: occupancy, borderColor: '#2563eb', borderWidth: 2, pointRadius: 0 };
      if (chart) { chart.data.labels = labels; chart.data.datasets = [ds]; chart.update(); return; }
      chart = new Chart(ctx, {
        type: 'line', data: { labels, datasets: [ds] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: '#6b7280',
                autoSkip: false,
                callback: (value, index) => (index % 100 === 0 ? index : '')
              },
              grid: { display: false }
            },
            y: {
              min: 0,
              max: 1,
              ticks: { color: '#6b7280' },
              grid: { display: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    let pyReady = (async () => {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage(['numpy']);

      // Provide the Python core (trimmed to essentials and mirrored from your file)
      const pyCode = `
import re, random
import numpy as nu
from dataclasses import dataclass

FOOTPRINT = 147
SMOOTH_WINDOW = 10
OCCUPANCY_KERNEL = 146

_ASCII_TO_IDX = nu.full(256, -1, dtype=nu.int8)
_ASCII_TO_IDX[ord('A')] = 0
_ASCII_TO_IDX[ord('C')] = 1
_ASCII_TO_IDX[ord('G')] = 2
_ASCII_TO_IDX[ord('T')] = 3

@dataclass(frozen=True)
class NucPositionResult:
    energy_raw: nu.ndarray
    energy_smoothed: nu.ndarray
    dyad_probability: nu.ndarray
    occupancy: nu.ndarray

def CleanSeq(dna: str) -> str:
    dna = dna.upper().replace('U','T')
    return re.sub(r"[^GATC]", "", dna)

def encode_seq(seq: str) -> nu.ndarray:
    b = nu.frombuffer(seq.encode('ascii'), dtype=nu.uint8)
    return _ASCII_TO_IDX[b]

def getweight(w: int, p: float, b: float) -> nu.ndarray:
    x = nu.arange(w, dtype=nu.float64)
    s = b * nu.sin(2 * nu.pi * x / p)
    weights = nu.empty((4,4,w), dtype=nu.float64)
    weights[0,0] = 0.25 + s
    weights[0,1] = 0.25 - s/3
    weights[0,2] = 0.25 - s/3
    weights[0,3] = 0.25 - s/3
    weights[1,0] = 0.25
    weights[1,1] = 0.25
    weights[1,2] = 0.25
    weights[1,3] = 0.25
    weights[2,0] = 0.25 + s/3
    weights[2,1] = 0.25 - s
    weights[2,2] = 0.25 + s/3
    weights[2,3] = 0.25 + s/3
    weights[3,0] = 0.25 + s
    weights[3,1] = 0.25 - s
    weights[3,2] = 0.25 - s
    weights[3,3] = 0.25 + s
    return weights

def calcE(seq: str, w: int, amplitude: float, period: float) -> nu.ndarray:
    idx = encode_seq(seq)
    L = idx.size
    num_win = L - w
    if num_win <= 0:
        return nu.array([], dtype=nu.float64)
    weights = getweight(w, period, amplitude)
    log_weights = nu.log(nu.clip(weights, 1e-300, None))
    log_p_f = nu.zeros(num_win, dtype=nu.float64)
    log_p_r = nu.zeros(num_win, dtype=nu.float64)
    i = nu.arange(num_win)
    for s in range(w):
        prev_f = idx[i + s - 1]
        curr_f = idx[i + s]
        log_p_f += log_weights[prev_f, curr_f, s]
        a = idx[i + w - s]
        b = idx[i + w - s - 1]
        rprev = 3 - a
        rcurr = 3 - b
        log_p_r += log_weights[rprev, rcurr, s]
    p_f = nu.exp(log_p_f) * (4.0 ** w)
    p_r = nu.exp(log_p_r) * (4.0 ** w)
    p_r = nu.roll(p_r, -1)
    E = (p_r * nu.log(p_r) + p_f * nu.log(p_f)) / (p_r + p_f)
    return E

def smooth(x: nu.ndarray, window_len: int) -> nu.ndarray:
    if window_len <= 1 or x.size == 0:
        return x
    s = nu.r_[x[window_len - 1 : 0 : -1], x, x[-1:-window_len:-1]]
    w = nu.ones(window_len, dtype=nu.float64)
    y = nu.convolve(w / w.sum(), s, mode='valid')
    return y[len(x[window_len - 1 : 0 : -1]) : len(x[window_len - 1 : 0 : -1]) + len(x) + 1]

def vanderlick(Energy: nu.ndarray, mu: float, footprint: int) -> nu.ndarray:
    E_out = Energy - mu
    n = E_out.size
    forward = nu.zeros(n, dtype=nu.float64)
    sum_prev = 0.0
    for i in range(n):
        forward[i] = nu.exp(E_out[i] - sum_prev)
        sum_prev += forward[i]
        if i >= footprint:
            sum_prev -= forward[i - footprint]
    backward = nu.zeros(n, dtype=nu.float64)
    r_forward = forward[::-1]
    sum_prod = 0.0
    for i in range(n):
        backward[i] = 1.0 - sum_prod
        sum_prod += r_forward[i] * backward[i]
        if i >= footprint:
            sum_prod -= r_forward[i - footprint] * backward[i - footprint]
    return forward * backward[::-1]

def CalcNucPositions(sequence: str, w: int, chemical_potential: float, amplitude: float, period: float) -> NucPositionResult:
    sequence = CleanSeq(sequence)
    energy_raw = calcE(sequence, w, amplitude, period)
    energy_smoothed = smooth(energy_raw, SMOOTH_WINDOW)
    dyad_probability = vanderlick(energy_smoothed, chemical_potential, w)
    left_pad = (w + 1) // 2
    right_pad = w // 2
    dyad_probability = nu.concatenate((nu.zeros(left_pad, dtype=nu.float64), dyad_probability, nu.zeros(right_pad, dtype=nu.float64)))
    occupancy = nu.convolve(dyad_probability, nu.ones(OCCUPANCY_KERNEL, dtype=nu.float64), mode='same')
    return NucPositionResult(energy_raw, energy_smoothed, dyad_probability, occupancy)
`;
      pyodide.runPython(pyCode);
      return pyodide;
    })();

    async function run() {
      try {
        elErr.textContent = '';
        const py = await pyReady;
        const seq = (elSeq.value || '').toString();
        const mu = parseFloat(elMu.value);
        const w = Math.max(1, Math.floor(parseFloat(elFoot.value)) || 147);
        const amp = parseFloat(elAmp.value);
        const per = parseFloat(elPer.value);
        if (seq.length < w + 2) { throw new Error(`Sequence too short for footprint w=${w}. Provide at least w+2 bases.`); }

        // call Python CalcNucPositions
        py.globals.set('JS_SEQ', seq);
        py.globals.set('JS_W', w);
        py.globals.set('JS_MU', mu);
        py.globals.set('JS_AMP', amp);
        py.globals.set('JS_PER', per);
        py.runPython(`res = CalcNucPositions(JS_SEQ, JS_W, JS_MU, JS_AMP, JS_PER)`);

        // fetch occupancy as a plain JS array
        const occ = py.runPython(`res.occupancy.tolist()`);
        render(occ);
      } catch (e) {
        console.error(e);
        elErr.textContent = String(e?.message || e);
      }
    }

    elRun.addEventListener('click', run);
    // Auto-run once after Pyodide is loaded
    (async () => { try { await pyReady; await run(); } catch (e) { elErr.textContent = String(e?.message || e); } })();
  </script>
</body>

</html>